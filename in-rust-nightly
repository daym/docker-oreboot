#!/bin/sh
set -e

# MacOS X
command -v realpath >/dev/null 2>&1 || {
	realpath() {
		if ! [ "$1" = "${1#/*}" ]
		then
			echo "$1"
		else
			echo "${PWD}/${1#./}"
		fi
	}
}

root="${PWD}"

if [ "$1" = "-k" ]
then
	shift
	opts="-d"
else
	opts="--rm"
fi

if [ "$1" = "-r" ]
then
	shift
	root="$1"
	root="`realpath \"${root}\"`"
	shift
fi

if [ "$1" = "-w" ]
then
	shift
	p="$1"
	p="`realpath \"${p}\"`"
	shift
else
	p="${PWD}"
fi

if [ "$1" = "-r" ]
then
	shift
	root="$1"
	root="`realpath \"${root}\"`"
	shift
fi

exec docker run ${opts} -e HOME -e RUSTC_FORCE_INCREMENTAL -e SSH_AGENT_PID -e SSH_AUTH_SOCK -e RUSTFLAGS -e CARGO_NET_OFFLINE -e RUST_TARGET_PATH -e TARGET_DIR -e PAYLOAD_A -e USER -e RUST_BACKTRACE --user "$(id -u)":"$(id -g)" -v "${root}:${root}" -w "${p}" rust-nightly-extra:latest "$@"
